<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procom 蔵書検索</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 8px;
        }

        input[type="text"] {
            max-width: 100%;
        }

        img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <div id="loading-message" style="position:fixed;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.8);z-index:9999;">
        データを取得中...
    </div>
    
    <header>
        <h1>Procom 蔵書検索</h1>
    </header>
    <main>
        <section>
            <div>
                <button id="simpleSearchBtn" type="button">簡易検索</button>
                <button id="detailSearchBtn" type="button">詳細検索</button>
            </div>
            <form id="searchForm">
                <div id="simpleSearchFields">
                    <input type="text" id="simpleQuery" placeholder="キーワード" aria-label="キーワード">
                </div>
                <div id="detailSearchFields" style="display:none;">
                    <input type="text" id="titleQuery" placeholder="タイトル" aria-label="タイトル">
                    <input type="text" id="authorQuery" placeholder="著者" aria-label="著者">
                    <input type="text" id="publisherQuery" placeholder="出版社" aria-label="出版社">
                    <input type="text" id="isbnQuery" placeholder="ISBN" aria-label="ISBN" pattern="[0-9A-Za-z\-]+">
                </div>
                <button type="submit">検索</button>
            </form>
        </section>
        <p><a href="books.html">本一覧</a></p>
    </main>
    <script>
// --- 蔵書データ取得・キャッシュ処理 ---
// Google Apps ScriptのAPIエンドポイント
const booksApiUrl = "https://script.google.com/macros/s/AKfycbwgeTeTRzSyHyHvEyXKsZzGqvpdP4LV-4L9IAOXJ74nnVD_gdY8ccGKYf_qt0YH-4sc/exec";
// ローディングメッセージのDOM取得
const loadingMessage = document.getElementById('loading-message');

// ローディング表示を出す
function showLoading() {
  loadingMessage.style.display = 'flex';
}
// ローディング表示を消す
function hideLoading() {
  loadingMessage.style.display = 'none';
}

// 蔵書データを取得（初回のみAPI、2回目以降はsessionStorageから即座に取得）
function getBooksData() {
  const cached = sessionStorage.getItem('booksData');
  if (cached) {
    // キャッシュがあればローディング非表示＆即座に返す
    hideLoading();
    // 必要ならここでデータを使う
    return Promise.resolve(JSON.parse(cached));
  } else {
    // キャッシュがなければAPIから取得し、取得中はローディング表示
    showLoading();
    return fetch(booksApiUrl)
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        // 取得したデータをキャッシュ
        sessionStorage.setItem('booksData', JSON.stringify(data));
        hideLoading();
        return data;
      })
      .catch(error => {
        // エラー時もローディング非表示
        console.error('本データの取得に失敗:', error);
        hideLoading();
        return null;
      });
  }
}

// ページ読み込み時に蔵書データ取得を実行
getBooksData();

// --- 検索フォームUI切替処理 ---
const simpleBtn = document.getElementById('simpleSearchBtn');
const detailBtn = document.getElementById('detailSearchBtn');
const simpleFields = document.getElementById('simpleSearchFields');
const detailFields = document.getElementById('detailSearchFields');
// 「簡易検索」ボタン押下時の表示切替
simpleBtn.addEventListener('click', () => {
    simpleFields.style.display = '';
    detailFields.style.display = 'none';
});
// 「詳細検索」ボタン押下時の表示切替
detailBtn.addEventListener('click', () => {
    simpleFields.style.display = 'none';
    detailFields.style.display = '';
});

// --- 検索フォーム送信時の遷移処理 ---
// 検索条件をURLパラメータにしてresult.htmlへ遷移
// 必要なパラメータのみセットすることでURLを簡潔に保つ
// result.html側でパラメータを受け取り検索処理を行う

document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    let params = new URLSearchParams();
    if (simpleFields.style.display !== 'none') {
        // 簡易検索時のパラメータ
        const q = document.getElementById('simpleQuery').value;
        params.set('q', q);
    } else {
        // 詳細検索時のパラメータ
        const title = document.getElementById('titleQuery').value;
        const author = document.getElementById('authorQuery').value;
        const publisher = document.getElementById('publisherQuery').value;
        const isbn = document.getElementById('isbnQuery').value;
        if (title) params.set('title', title);
        if (author) params.set('author', author);
        if (publisher) params.set('publisher', publisher);
        if (isbn) params.set('isbn', isbn);
    }
    // 検索結果ページへ遷移
    window.location.href = 'result.html?' + params.toString();
});
</script>
</body>

</html>